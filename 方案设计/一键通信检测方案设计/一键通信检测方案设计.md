# ä¸€é”®é€šä¿¡æ£€æµ‹æ–¹æ¡ˆ

## é—®é¢˜èƒŒæ™¯

æ–¹ä¾¿å¿«æ·çš„å‘ç°è®­ç»ƒèŠ‚ç‚¹çš„ç½‘ç»œé€šä¿¡å’Œé€šä¿¡æ€§èƒ½é—®é¢˜ã€‚

å¾…è§£å†³é—®é¢˜ï¼š
1.  é€šä¿¡åº“æ€§èƒ½æ£€æµ‹
2.  rama ç½‘ç»œæ€§èƒ½æ£€æµ‹
3.  ä¿å­˜å†å²æ£€æµ‹æ•°æ®

## ç«å“åˆ†æ

å¤©ç¿¼äº‘

RDMAç½‘ç»œæ€§èƒ½æ£€æµ‹ï¼š

![alt text](image-1.png)
![alt text](image-2.png)

é€šè®¯åº“æ€§èƒ½æ£€æµ‹ï¼š

![alt text](image-3.png)




## è§£å†³æ–¹æ¡ˆ


### RDMAç½‘ç»œæ€§èƒ½æ£€æµ‹

éœ€è¦ä¼ å…¥çš„å‚æ•°ï¼š
1.  æµ‹è¯•çš„èŠ‚ç‚¹åˆ—è¡¨ï¼Œ
2.  ç½‘å¡è®¾å¤‡åç§°ï¼Œ
3.  ç‰©ç†ç«¯å£ï¼Œ
4.  æ“ä½œç±»å‹ï¼ˆread/write/sendï¼‰ï¼Œ

**æ•´ä½“æµç¨‹å¦‚ä¸‹ï¼š**

é€šè¿‡é¡µé¢å‚æ•°ä¼ é€’åˆ° syncaction CR ä¸­ï¼Œæ ¹æ®å‚æ•°æ‹¼å‡‘å®Œæ•´çš„rdma å¸¦å®½æ£€æµ‹å‘½ä»¤ã€‚ç„¶åé€šè¿‡è°ƒåº¦å™¨å°†æ€§èƒ½æ£€æµ‹å·¥å…·podä¸‹å‘åˆ°å¯¹åº”çš„èŠ‚ç‚¹ä¸Šæ‰§è¡Œã€‚æœ€åä¿å­˜æ£€æµ‹ç»“æœã€‚


### é€šä¿¡åº“æ€§èƒ½æµ‹è¯•

éœ€è¦ä¼ å…¥çš„å‚æ•°ï¼ˆä¹Ÿå¯ä»¥æ ¹æ®èµ„æºæ± æ¥è¿›è¡Œæµ‹è¯•ï¼Œæµ‹è¯•æ•´ä¸ªèµ„æºæ± ä¸‹è®¡ç®—èŠ‚ç‚¹ä¹‹é—´æ‰€æœ‰è®¡ç®—èµ„æºçš„é€šä¿¡æ€§èƒ½ï¼‰ï¼š 
1. æµ‹è¯•çš„èŠ‚ç‚¹åˆ—è¡¨ï¼Œ
2. é€šä¿¡ç®—å­ç±»å‹(all_reduce,all_gather,brodcastç­‰)ï¼Œ
3. èŠ‚ç‚¹å‚ä¸é€šä¿¡çš„å¡çš„æ•°é‡ï¼Œ


**æ•´ä½“æµç¨‹å¦‚ä¸‹ï¼š**

é€šè¿‡é¡µé¢å‚æ•°ä¼ é€’åˆ° syncaction CR ä¸­ï¼Œæ ¹æ®å‚æ•°æ‹¼å‡‘å®Œæ•´çš„nccl é€šä¿¡æ£€æµ‹å‘½ä»¤ã€‚ç„¶åé€šè¿‡è°ƒåº¦å™¨å°†æ€§èƒ½æ£€æµ‹å·¥å…·podä¸‹å‘åˆ°å¯¹åº”çš„èŠ‚ç‚¹ä¸Šæ‰§è¡Œã€‚æœ€åä¿å­˜æ£€æµ‹ç»“æœã€‚


```mermaid
sequenceDiagram
    participant ç”¨æˆ·
    participant å‰ç«¯é¡µé¢
    participant åç«¯æœåŠ¡
    participant Kubernetes API Server
    participant è°ƒåº¦å™¨
    participant ç›®æ ‡èŠ‚ç‚¹
    participant æ€§èƒ½æ£€æµ‹å·¥å…·Pod
    
    ç”¨æˆ·->>å‰ç«¯é¡µé¢: è¾“å…¥å‚æ•°ï¼ˆå¦‚èŠ‚ç‚¹åˆ—è¡¨ã€æ£€æµ‹ç±»å‹ï¼‰
    å‰ç«¯é¡µé¢->>åç«¯æœåŠ¡: ä¼ é€’å‚æ•°ï¼ˆPOSTè¯·æ±‚ï¼‰
    åç«¯æœåŠ¡->>åç«¯æœåŠ¡: è§£æå‚æ•°ï¼Œæ‹¼å‡‘NCCLå‘½ä»¤ï¼ˆå¦‚`nccl-tests/build/all_reduce_perf -b 1 -e 1024 -f 2`ï¼‰
    åç«¯æœåŠ¡->>Kubernetes API Server: åˆ›å»ºCRï¼ˆCustom Resourceï¼‰Syncactionï¼ŒåŒ…å«NCCLå‘½ä»¤
    Kubernetes API Server->>è°ƒåº¦å™¨: è§¦å‘Podè°ƒåº¦
    è°ƒåº¦å™¨->>ç›®æ ‡èŠ‚ç‚¹: ä¸‹å‘æ€§èƒ½æ£€æµ‹å·¥å…·Pod
    ç›®æ ‡èŠ‚ç‚¹->>æ€§èƒ½æ£€æµ‹å·¥å…·Pod: å¯åŠ¨å®¹å™¨ï¼Œæ‰§è¡ŒNCCLå‘½ä»¤
    æ€§èƒ½æ£€æµ‹å·¥å…·Pod->>ç›®æ ‡èŠ‚ç‚¹: è¾“å‡ºæ£€æµ‹ç»“æœï¼ˆæ—¥å¿—/æ–‡ä»¶ï¼‰
    ç›®æ ‡èŠ‚ç‚¹->>åç«¯æœåŠ¡: ä¸Šä¼ ç»“æœæ•°æ®ï¼ˆAPIæˆ–æ–‡ä»¶å­˜å‚¨ï¼‰
    åç«¯æœåŠ¡->>åç«¯æœåŠ¡: è§£æç»“æœï¼Œå­˜å…¥æ•°æ®åº“
    åç«¯æœåŠ¡->>å‰ç«¯é¡µé¢: è¿”å›ç»“æœæŸ¥è¯¢é“¾æ¥
    å‰ç«¯é¡µé¢->>ç”¨æˆ·: æ˜¾ç¤ºæ£€æµ‹ç»“æœ
```





## æ–¹æ¡ˆéªŒè¯


### nccl é€šä¿¡åº“æµ‹è¯•


ä½¿ç”¨volcano job æ¥è¿›è¡ŒåŠŸèƒ½éªŒè¯ï¼š

é•œåƒï¼šregistry.cnbita.com:5000/cluster-images/nccl-tests:v2.13-cuda12.2

```bash
2æœº2å¡

mpirun -np 2 -H trainingjob-m123456-m1-0.trainingjob-m123456,trainingjob-m123456-m2-0.trainingjob-m123456 --allow-run-as-root  --output-filename log_output --merge-stderr-to-stdout ./all_reduce_perf -b 32M -e 512M  -f 2 -g 2


mpirun -np 2 -H 10.1.30.41,10.1.30.42  --allow-run-as-root -bind-to none -map-by slot -mca coll_hcoll_enable 0 -mca pml ob1 -mca btl_tcp_if_include  bond0 -mca btl ^openib -x NCCL_IB_GID_INDEX=3 -x NCCL_SOCKET_IFNAME=bond0  -x NCCL_IB_HCA=^mlx5_8 -x NCCL_IB_TC=128 -x NCCL_IB_QPS_PER_CONNECTION=8 -x NCCL_DEBUG=INFO -x NCCL_ALGO=Ring /data/wangshi/nccl-tests-2.13.11/build/all_reduce_perf -b 32M -e 8G  -f 2 -g 8


```
éªŒè¯ç»“æœå¦‚ä¸‹ï¼š

![alt text](image.png)


### hccl é€šä¿¡åº“æµ‹è¯•

å•æœºåœºæ™¯

```bash
./bin/all_reduce_test -p 8 -b 8K -e 64M -f 2 -d fp32 -o sum
```

å¤šæœºåœºæ™¯
```bash
mpirun -f hostfile -n 16 ./bin/all_reduce_test -p 8 -b 8K -e 64M -f 2 -d fp32 -o sum

```



### è®¡ç®—èŠ‚ç‚¹é—´ç½‘å¡å¸¦å®½æµ‹è¯•

æŸ¥çœ‹å­˜åœ¨çš„ib&roceç½‘å¡

```bash
ibdev2netdev
```


```bash
æœåŠ¡ç«¯
ib_write_bw -d mlx5_0 -x 3  


å®¢æˆ·ç«¯
ib_write_bw -d mlx5_0 10.1.70.1 --report_gbits 

```

éªŒè¯ç»“æœå¦‚ä¸‹ï¼š

![alt text](image-4.png)

### æ—¶å»¶æµ‹è¯•

```bash

æœåŠ¡ç«¯
ib_send_lat -d mlx5_0 -x 3

å®¢æˆ·ç«¯
ib_send_lat -d mlx5_0 10.1.70.1  
```

![alt text](image-5.png)

## æ³¢åŠåˆ†æ

ä¸å½±å“å½“å‰ç±»è„‘äº‘å…¶å®ƒæœåŠ¡ã€‚

## è¯„å®¡ç»“æœ

#TODO

## å‚è€ƒæ–‡æ¡£

[hccl é€šä¿¡åº“æµ‹è¯•æ•™ç¨‹](https://www.hiascend.com/document/detail/zh/canncommercial/80RC1/devaids/auxiliarydevtool/HCCLpertest_16_0003.html)
[å¤©ç¿¼äº‘é€šä¿¡æ£€æµ‹åœ°å€](https://cloudwarrior-ai.ctyun.cn/central/diagnose/cclDiagnosis)


```bash
#!/bin/bash

# ===============================================
# Script: rdma_test.sh
# Author: å°é”‹å­¦é•¿
# Description:
#   ä¸€é”®è¿è¡Œ RDMA å¸¦å®½æµ‹è¯•ï¼ˆib_write_bwï¼‰å·¥å…·ï¼Œè‡ªåŠ¨å®Œæˆï¼š
#     - è‡ªåŠ¨æ£€æµ‹ GID index
#     - åˆ‡æ¢ CPU governor ä¸º performance
#     - æ”¯æŒ server/client æ¨¡å¼
#     - æ”¯æŒ read / write / send æ“ä½œç±»å‹ï¼ˆé»˜è®¤ readï¼‰
#     - æ”¯æŒä¼ å…¥è®¾å¤‡åã€ç«¯å£å·
#     - æµ‹è¯•åè‡ªåŠ¨æ¢å¤ CPU governor
#
# Requirements:
#   - ib_write_bw å·¥å…·ï¼ˆæ¥è‡ª perftest åŒ…ï¼‰
#   - Mellanox é©±åŠ¨å·²æ­£ç¡®åŠ è½½
#   - RDMA è®¾å¤‡æ”¯æŒ RoCE å¹¶å·²é…ç½® IP + GID
#
# Usage:
#   Server æ¨¡å¼ï¼š
#     bash rdma_test.sh server
#     bash rdma_test.sh server [device] [port] [mode_type]
#
#   Client æ¨¡å¼ï¼š
#     bash rdma_test.sh client <server_ip>
#     bash rdma_test.sh client <server_ip> [device] [port] [mode_type]
#
# Examples:
#   bash rdma_test.sh server mlx5_1 1 read
#   bash rdma_test.sh client 192.168.5.228 mlx5_1 1 read
#
# Note:
#   - é»˜è®¤è®¾å¤‡ä¸º mlx5_1ï¼Œé»˜è®¤ç‰©ç†ç«¯å£ä¸º 1
#   - GID index ä¼šæ ¹æ®æœ¬åœ° IP è‡ªåŠ¨é€‰æ‹©
#   - æ”¯æŒå¼‚å¸¸é€€å‡ºè‡ªåŠ¨æ¸…ç† CPU governor è®¾ç½®
# ===============================================

# CONFIGURATION (é»˜è®¤å€¼)
MODE=""           # ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºè¿è¡Œæ¨¡å¼ï¼Œserver æˆ– client
PEER_IP=""        # ç¬¬äºŒä¸ªå‚æ•°ä½œä¸º Server IPï¼ˆä»… client æ¨¡å¼ä½¿ç”¨ï¼‰
DEVICE="mlx5_1"   # ç¬¬ä¸‰ä¸ªå‚æ•°ä¸ºè®¾å¤‡åï¼Œé»˜è®¤å€¼ä¸º mlx5_1
PORT=1            # ç¬¬å››ä¸ªå‚æ•°ä¸ºç‰©ç†ç«¯å£ï¼Œé»˜è®¤ 1
MODE_TYPE="read"  # ç¬¬äº”ä¸ªå‚æ•°ä¸ºä¼ è¾“æ¨¡å¼ï¼Œread/write/sendï¼ˆé»˜è®¤ readï¼‰
GID_INDEX=-1      # è‡ªåŠ¨æ£€æµ‹

# è§£æå‚æ•°
ARGS=$(getopt -o m:i:d:p:t: \
  -l mode:,peer_ip:,device:,port:,mode_type: \
  -n "$0" -- "$@")
if [ $? -ne 0 ]; then
  echo "âŒ å‚æ•°è§£æå¤±è´¥"
  exit 1
fi
eval set -- "$ARGS"
while true; do
  case "$1" in
    -m|--mode) MODE="$2"; shift 2 ;;
    -i|--peer_ip) PEER_IP="$2"; shift 2 ;;
    -d|--device) DEVICE="$2"; shift 2 ;;
    -p|--port) PORT="$2"; shift 2 ;;
    -t|--mode_type) MODE_TYPE="$2"; shift 2 ;;
    --) shift; break ;;
    *) echo "âŒ æœªçŸ¥å‚æ•°: $1" >&2; exit 1 ;;
  esac
done


# ç¡®å®šå®é™…è¿è¡Œçš„æµ‹è¯•å·¥å…·
case "$MODE_TYPE" in
  write) TEST_TOOL="ib_write_bw" ;;
  send)  TEST_TOOL="ib_send_bw" ;;
  *)     TEST_TOOL="ib_read_bw" ;;
esac
echo "==== RDMA å¿«é€Ÿæ£€æŸ¥å’Œæµ‹è¯•å·¥å…· ===="
echo "è¿è¡Œæ¨¡å¼   : $MODE"
echo "æ“ä½œç±»å‹   : $TEST_TOOL"
echo "ç½‘å¡è®¾å¤‡   : $DEVICE"
echo "ç‰©ç†ç«¯å£   : $PORT"
[[ "$MODE" == "client" ]] && echo "ç›®æ ‡Server: $PEER_IP"


# === 1. æ£€æŸ¥ Mellanox é©±åŠ¨åŠ è½½çŠ¶æ€ ===
echo "[1] æ£€æŸ¥é©±åŠ¨æ¨¡å—åŠ è½½çŠ¶æ€"
lsmod | grep mlx5 || echo "âŒ æœªåŠ è½½ Mellanox é©±åŠ¨æ¨¡å—"


# === 2. æŸ¥çœ‹è®¾å¤‡çŠ¶æ€ ===
echo -e "\n[2] æŸ¥çœ‹è®¾å¤‡åˆ—è¡¨ä¸çŠ¶æ€"
ibv_devinfo -d "$DEVICE" || { echo "âŒ RDMA è®¾å¤‡ä¸å¯ç”¨"; exit 1; }


# === 3. è‡ªåŠ¨è¯†åˆ« GID index ===
echo -e "\n[3] æ˜¾ç¤ºç«¯å£ $PORT çš„ GID è¡¨ï¼š"
for i in {0..15}; do
  GID=$(cat /sys/class/infiniband/${DEVICE}/ports/${PORT}/gids/$i)
  echo "GID[$i] = $GID"
  if [[ "$GID" =~ .*c0a8.* ]]; then  # æ£€æŸ¥æ˜¯å¦å«æœ‰192.168.5.xå¯¹åº”åå…­è¿›åˆ¶æ®µ
    GID_INDEX=$i
  fi
done
if [[ "$GID_INDEX" -eq "-1" ]]; then
  echo "âŒ æœªèƒ½è‡ªåŠ¨è¯†åˆ«å‡º GID indexï¼Œè¯·æ‰‹åŠ¨è®¾ç½® GID_INDEX"
  exit 1
else
  echo "âœ… ä½¿ç”¨ GID index: $GID_INDEX"
fi


# === 3.5 ä¸´æ—¶å°† CPU governor åˆ‡æ¢ä¸º performanceï¼Œå¹¶æ³¨å†Œæ¢å¤ ===
echo -e "\n[3.5] ä¸´æ—¶åˆ‡æ¢ CPU governor ä¸º performance"
declare -A ORIGINAL_GOVERNORS
for cpu in /sys/devices/system/cpu/cpu[0-9]*; do
  gov_file="$cpu/cpufreq/scaling_governor"
  cpu_name=$(basename "$cpu")
  ORIGINAL_GOVERNORS[$cpu_name]=$(cat "$gov_file")
  echo performance | sudo tee "$gov_file" > /dev/null
done
sleep 1

restore_governors() {
  echo -e "\n[æ¸…ç†] æ¢å¤åŸæœ‰ CPU governor è®¾ç½®..."
  for cpu in "${!ORIGINAL_GOVERNORS[@]}"; do
    echo "${ORIGINAL_GOVERNORS[$cpu]}" | sudo tee /sys/devices/system/cpu/$cpu/cpufreq/scaling_governor > /dev/null
  done
}
trap restore_governors EXIT


# === 4. å¯åŠ¨ RDMA æµ‹è¯• ===
echo -e "\n[4] å¯åŠ¨ ib_write_bw æµ‹è¯•"
COMMON_ARGS="-d $DEVICE -i $PORT -x $GID_INDEX -s 65536 -q 8 -n 500000 --noPeak --report_gbits"

if [[ "$MODE" == "server" ]]; then
  echo "ğŸŸ¢ æ­£åœ¨å¯åŠ¨ serverï¼ˆè®¾å¤‡=$DEVICE, ç«¯å£=$PORT, GID=$GID_INDEX, æ¨¡å¼=$TEST_TOOLï¼‰"
  # send æ¨¡å¼æç¤º + å‚æ•°å¤„ç†
  if [[ "$MODE_TYPE" == "send" ]]; then
    echo -e "\nğŸ“¢ æ³¨æ„ï¼šå½“å‰ä¸º send æ¨¡å¼ï¼Œclientéœ€è¦ä¸»åŠ¨å‘é€æ•°æ®"
    if [[ "$MODE" == "server" ]]; then
      COMMON_ARGS="$COMMON_ARGS --run_infinitely"
    fi
  fi
  echo "ğŸ”§ å®é™…æ‰§è¡Œå‘½ä»¤ï¼šsudo $TEST_TOOL $COMMON_ARGS"
  while true; do
    echo -e "\nğŸŸ¢ ç­‰å¾… client è¿æ¥..."
    sudo $TEST_TOOL $COMMON_ARGS
    echo -e "\nâœ… å½“å‰ client æµ‹è¯•å®Œæˆï¼Œç­‰å¾…ä¸‹ä¸€ä¸ªè¿æ¥...\n"
    sleep 1
  done
elif [[ "$MODE" == "client" ]]; then
  if [[ -z "$PEER_IP" ]]; then
    echo "âŒ é”™è¯¯ï¼šclient æ¨¡å¼éœ€è¦æŒ‡å®š server IP"
    echo "ç”¨æ³•ï¼š$0 client <server_ip> [device] [port] [mode_type]"
    exit 1
  fi
  echo "ğŸš€ æ­£åœ¨è¿æ¥åˆ° server $PEER_IPï¼ˆè®¾å¤‡=$DEVICE, ç«¯å£=$PORT, GID=$GID_INDEX, æ¨¡å¼=$TEST_TOOLï¼‰"
  echo "ğŸ”§ å®é™…æ‰§è¡Œå‘½ä»¤ï¼šsudo $TEST_TOOL $COMMON_ARGS $PEER_IP"
  sudo $TEST_TOOL $COMMON_ARGS "$PEER_IP"
else
  echo "âŒ é”™è¯¯ï¼šå¿…é¡»æŒ‡å®šæ¨¡å¼å‚æ•° server æˆ– client"
  echo "ç”¨æ³•ï¼š$0 server [device] [port] [mode_type] æˆ– $0 client <server_ip> [device] [port] [mode_type]"
  exit 1
fi
```
æœåŠ¡ç«¯
bash rdma_test.sh -m server -t read

å®¢æˆ·ç«¯
bash test_rdma.sh -m client -i 192.168.5.228 -d mlx5_1 -p 1 -t read 




éƒ¨ç½²å‘½ä»¤ï¼š
git clone -b test https://gitlab.bitahub.com/hero-os/herokey.git
cd herokey/installpkg/single/monitor/kube-prometheus
bash install.sh ./

æ³¨æ„äº‹é¡¹ï¼š

1. å› å½“å‰ç‰ˆæœ¬çš„Prometheuséƒ¨ç½²éœ€è¦å¯¹åº”çš„StorageClasså­˜åœ¨,å½“å‰é»˜è®¤ä½¿ç”¨çš„SCæ˜¯csi-s3ï¼Œæ‰€ä»¥éœ€è¦æ¸…ç†æ—§ç‰ˆæœ¬Prometheusçš„pvå’Œpvcï¼ŒæœåŠ¡æ‰èƒ½æ­£å¸¸æ›´æ–°å‡çº§ã€‚



linux é…ç½®æœåŠ¡ä»£ç†

```bash
export http_proxy=http://192.168.13.25:7890
export https_proxy=http://192.168.13.25:7890
```

docker é…ç½®ä»£ç†

```bash
vi /usr/lib/systemd/system/docker.service


[Service]
...
# proxy
Environment="HTTP_PROXY=http://192.168.13.25:7890"
Environment="HTTPS_PROXY=http://192.168.13.25:7890"
Environment="NO_PROXY=localhost,127.0.0.1,172.17.*.*,10.0.*.*,registry.hub.com,registry.cnbita.com"


docker daemon-reload
systemctl restart docker

```